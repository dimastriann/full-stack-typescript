// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 Int                       @id @default(autoincrement())
  name               String
  email              String                    @unique
  password           String
  phone              String?
  mobile             String?
  firstName          String
  lastName           String?
  status             Boolean                   @default(true)
  address            String?
  bio                String?
  birthDate          DateTime?
  gender             Gender?
  role               UserRole                  @default(USER)
  tasks              Task[]
  projects           Project[]
  timesheets         Timesheet[]
  comments           Comment[]
  projectMemberships ProjectMember[]
  workspaceMembers   WorkspaceMember[]
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  conversations      ConversationParticipant[]
  messages           Message[]
}

model Workspace {
  id            Int               @id @default(autoincrement())
  name          String
  description   String?
  members       WorkspaceMember[]
  projects      Project[]
  projectStages ProjectStage[]
  taskStages    TaskStage[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  conversations Conversation[]
}

model WorkspaceMember {
  id          Int           @id @default(autoincrement())
  workspaceId Int
  userId      Int
  role        WorkspaceRole @default(MEMBER)
  joinedAt    DateTime      @default(now())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model ProjectStage {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  color       String    @default("#808080")
  sequence    Int       @default(5)
  isCompleted Boolean   @default(false)
  isCanceled  Boolean   @default(false)
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projects    Project[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model TaskStage {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  color       String    @default("#808080")
  sequence    Int       @default(5)
  isCompleted Boolean   @default(false)
  isCanceled  Boolean   @default(false)
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks       Task[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Project {
  id            Int             @id @default(autoincrement())
  name          String
  description   String?
  tasks         Task[]
  responsible   User?           @relation(fields: [responsibleId], references: [id])
  responsibleId Int?
  stage         ProjectStage?   @relation(fields: [stageId], references: [id])
  stageId       Int?
  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId   Int
  comments      Comment[]
  attachments   Attachment[]
  timesheets    Timesheet[]
  members       ProjectMember[]
  sequence      Int             @default(1000)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model Task {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  user        User         @relation(fields: [userId], references: [id])
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId      Int
  projectId   Int
  stage       TaskStage?   @relation(fields: [stageId], references: [id])
  stageId     Int?
  comments    Comment[]
  attachments Attachment[]
  timesheets  Timesheet[]
  sequence    Int          @default(1000)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Timesheet {
  id          Int      @id @default(autoincrement())
  description String
  date        DateTime
  timeSpent   Float
  userId      Int
  projectId   Int
  project     Project  @relation(fields: [projectId], references: [id])
  taskId      Int?
  user        User     @relation(fields: [userId], references: [id])
  task        Task?    @relation(fields: [taskId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Comment {
  id        Int       @id @default(autoincrement())
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    Int
  projectId Int?
  taskId    Int?
  parentId  Int?
  user      User      @relation(fields: [userId], references: [id])
  project   Project?  @relation(fields: [projectId], references: [id])
  task      Task?     @relation(fields: [taskId], references: [id])
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
}

enum UserRole {
  ADMIN
  MANAGER
  USER
}

enum Gender {
  Male
  Female
}

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DEPLOYED
  TESTING
  REVISION
  DONE
  CANCELED
}

model Attachment {
  id        Int      @id @default(autoincrement())
  filename  String
  path      String
  mimeType  String
  size      Int
  createdAt DateTime @default(now())

  projectId Int?
  project   Project? @relation(fields: [projectId], references: [id])
  taskId    Int?

  task Task? @relation(fields: [taskId], references: [id])
}

model ProjectMember {
  id          Int         @id @default(autoincrement())
  userId      Int
  projectId   Int
  workspaceId Int
  role        ProjectRole @default(MEMBER)
  joinedAt    DateTime    @default(now())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([projectId])
  @@index([userId])
}

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum ConversationType {
  CHANNEL
  DIRECT
}

model Conversation {
  id           Int                       @id @default(autoincrement())
  name         String?
  type         ConversationType          @default(DIRECT)
  workspaceId  Int?
  workspace    Workspace?                @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  participants ConversationParticipant[]
  messages     Message[]
}

model ConversationParticipant {
  id             Int      @id @default(autoincrement())
  userId         Int
  conversationId Int
  joinedAt       DateTime @default(now())
  lastReadAt     DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
}

model Message {
  id             Int      @id @default(autoincrement())
  content        String
  linkPreview    Json?
  senderId       Int
  conversationId Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}
